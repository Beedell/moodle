define(["jquery","core/dragdrop"],function(a,b){"use strict";var c={q:{},init:function(d){var e=d.topnode.replace(/^div#/,"");c.q[e]={dropzones:[],readOnly:!1,topnode:null,bgImageUrl:null,doc:null,colours:["#FFFFFF","#B0C4DE","#DCDCDC","#D8BFD8","#87CEFA","#DAA520","#FFD700","#F0E68C"],nextColourIndex:0,shapes:[],svg:null},c.q[e].dropzones=d.dropzones,c.q[e].readOnly=d.readOnly,c.q[e].topnode=a(d.topnode),c.q[e].bgImageUrl=d.bgimgurl,c.q[e].doc=c.docStructure(e),c.q[e].readOnly||(c.q[e].doc.dragItemsArea.on("mousedown touchstart",function(d){d.preventDefault();var e=a(d.target.parentNode);e.hasClass("dragitem")&&(e.addClass("beingdragged"),b.prepare(d),b.start(d,e,c.dragMove,c.dragEnd))}),c.q[e].doc.dragItemsArea.on("keydown keypress",{questionNo:e},c.dropzoneKeyPress),a(window).on("resize",{questionNo:e},c.redrawDragsAndDrops)),c.loadImage(e)},loadImage:function(a){c.q[a].doc.bgImage().on("load",{questionNo:a},c.redrawDragsAndDrops),c.q[a].doc.bgImage().attr("src",c.q[a].bgImageUrl),c.q[a].doc.bgImage().css({border:"1px solid #000","max-width":"none"})},redrawDragsAndDrops:function(b){var d=b.data.questionNo;if(c.q[d].doc.dragItems().each(function(b,c){a(c).addClass("unneeded")}),c.q[d].doc.inputsForChoices(d).each(function(a,b){for(var e=c.getChoiceNoForNode(b),f=c.getCoords(d,b),g=c.q[d].doc.dragItemHome(e),h=0;h<f.length;h++){var i=c.q[d].doc.dragItemForChoice(e,h);!i.length||i.hasClass("beingdragged")?i=c.cloneNewDragItem(d,g,h):i.removeClass("unneeded"),i.css("left",f[h][0]).css("top",f[h][1])}}),c.q[d].doc.dragItems().each(function(b,c){var d=a(c);d.hasClass("unneeded")&&!d.hasClass("beingdragged")&&d.remove()}),0!==c.q[d].dropzones.length){c.restartColours(d);for(var e in c.q[d].dropzones){var f=c.getNextColour(d),g=c.q[d].dropzones[e];c.addDropzone(d,e,g.markertext,g.shape,g.coords,f,!0)}c.drawDropzones(d)}},cloneNewDragItem:function(a,b,c){var d=b.clone(!0);return d.removeClass("draghome"),d.addClass("dragitem"),d.addClass("item"+c),d.addClass("questionno"+a),d.find("span.markertext").css("opacity",.6),b.after(d),d.attr("tabIndex",c),d},saveCoordsForChoice:function(a,b,d){for(var e,f,g,h=[],i=!0,j=0;j<=c.q[a].doc.dragItemsForChoice(b).length;j++)g=c.q[a].doc.dragItemForChoice(b,j),g.length&&(g.hasClass("beingdragged")||(e=c.convertToBgImgXY(a,[g.offset().left,g.offset().top]),c.coordsInBgImg(a,e)&&(h[h.length]=e)),d&&0!==d.length&&d.get(0).innerText===g.get(0).innerText&&(i=!1));i&&(e=c.convertToBgImgXY(a,[d.offset().left,d.offset().top]),c.coordsInBgImg(a,e)&&(h[h.length]=e)),f=h.join(";"),c.q[a].doc.inputForChoice(a,b).val(f)},coordsInBgImg:function(a,b){return b[0]>0&&b[1]>0&&b[0]<=c.q[a].doc.bgImage().width()&&b[1]<=c.q[a].doc.bgImage().height()},constrainToBgImg:function(a,b){var d=c.convertToBgImgXY(a,b);return d[0]=Math.max(0,d[0]),d[1]=Math.max(0,d[1]),d[0]=Math.min(c.q[a].doc.bgImage().width(),d[0]),d[1]=Math.min(c.q[a].doc.bgImage().height(),d[1]),c.convertToWindowXY(a,d)},convertToBgImgXY:function(a,b){return[Number(b[0])-c.q[a].doc.bgImage().offset().left-1,Number(b[1])-c.q[a].doc.bgImage().offset().top-1]},convertToWindowXY:function(a,b){return[Number(b[0])+c.q[a].doc.bgImage().position().left+1,Number(b[1])+c.q[a].doc.bgImage().position().top+1]},getCoords:function(b,d){var e=c.getChoiceNoForNode(d),f=a(d).val(),g=a(d).hasClass("infinite"),h=Number(c.getClassnameNumericSuffix(d,"noofdrags")),i=c.q[b].doc.dragItemBeingDragged(e).length>0,j=[];if(""!==f)for(var k=f.split(";"),l=0;l<k.length;l++)j[l]=c.convertToWindowXY(b,k[l].split(","));var m=j.length+(i?1:0);return(g||m<h)&&(j[j.length]=c.dragHomeXY(b,e)),j},dragHomeXY:function(a,b){var d=c.q[a].doc.dragItemHome(b);return[d.position().left,d.position().top-12]},getChoiceNoForNode:function(a){return Number(c.getClassnameNumericSuffix(a,"choice"))},getQuestionNoForNode:function(a){return"q"+Number(c.getClassnameNumericSuffix(a,"questionnoq"))},getClassnameNumericSuffix:function(b,c){var d=a(b).attr("class");if(void 0!==d&&""!==d)for(var e=d.split(" "),f=0;f<e.length;f++){var g=new RegExp("^"+c+"([0-9])+$");if(g.test(e[f])){var h=new RegExp("([0-9])+$"),i=h.exec(e[f]);return Number(i[0])}}return null},dropzoneKeyPress:function(b){var d,e,f,g,h,i;if(d=a(b.target),e=[d.offset().left,d.offset().top],f={32:"remove",37:"left",38:"up",39:"right",40:"down",65:"left",87:"up",68:"right",83:"down",27:"remove"},g=f[b.keyCode]){switch(b.preventDefault(),g){case"left":e[0]-=1;break;case"right":e[0]+=1;break;case"down":e[1]+=1;break;case"up":e[1]-=1;break;case"remove":e=null}h=c.getQuestionNoForNode(d),i=c.getChoiceNoForNode(d),e=null!==e?c.constrainToBgImg(h,e):c.dragHomeXY(h,i),d.css("left",e[0]).css("top",e[1]),c.saveCoordsForChoice(h,i,d),c.redrawDragsAndDrops({data:{questionNo:h}})}},dragMove:function(){},dragEnd:function(a,b,d){var e,f;d.removeClass("beingdragged"),f=c.getQuestionNoForNode(d),e=c.getChoiceNoForNode(d),c.saveCoordsForChoice(f,e,d),c.redrawDragsAndDrops({data:{questionNo:f}})},docStructure:function(a){var b=c.q[a].topnode.find("div.dragitems:first");return{dragItemsArea:b,bgImage:function(){return c.q[a].topnode.find(".dropbackground:first")},dragItems:function(){return b.find(".dragitem")},dragItemsForChoice:function(a){return b.find("span.dragitem.choice"+a)},dragItemForChoice:function(a,c){return b.find("span.dragitem.choice"+a+".item"+c)},dragItemBeingDragged:function(a){return b.find("span.dragitem.beingdragged.choice"+a)},dragItemHome:function(a){return b.find("span.draghome.choice"+a)},dragItemHomes:function(){return b.find("span.draghome")},inputsForChoices:function(a){return c.q[a].topnode.find("input.choices")},inputForChoice:function(a,b){return c.q[a].topnode.find("input.choice"+b)},markerTexts:function(a){return c.q[a].topnode.find("div.markertexts")}}},restartColours:function(a){c.q[a].nextColourIndex=0},getNextColour:function(a){var b=c.q[a].colours[c.q[a].nextColourIndex];return c.q[a].nextColourIndex++,c.q[a].nextColourIndex===c.q[a].colours.length&&(c.q[a].nextColourIndex=0),b},addDropzone:function(a,b,d,e,f,g,h){var i;if(i=h?c.q[a].doc.markerTexts(a).find("span.markertext"+b+" a"):c.q[a].doc.markerTexts(a).find("span.markertext"+b),i.length)""!==d?i.html(d):i.remove();else if(""!==d){var j="markertext markertext"+b;h?c.q[a].doc.markerTexts(a).append('<span class="'+j+'"><a href="#">'+d+"</a></span>"):c.q[a].doc.markerTexts(a).append('<span class="'+j+'">'+d+"</span>")}e=e.replace(/^./,e[0].toUpperCase());var k="addShape"+e;if(c[k]instanceof Function){var l=c[k](a,b,f,g);if(null!==l){var m=c.q[a].topnode.find("div.ddarea div.markertexts span.markertext"+b);if(null!==m){m.css("opacity","0.6"),l[0]-=m.outerWidth()/2,l[1]-=m.outerHeight()/2;var n=c.convertToWindowXY(a,l);m.css("position","absolute").css("left",n[0]-4).css("top",n[1]);var o=m.find("a");null!==o&&(o.on("click",function(){c.q[a].shapes[b].attr("fill-opacity",.7)}),o.attr("tabIndex",0))}}}},drawDropzones:function(b){var d,e,f,g,h;if(!(c.q[b].shapes.length<1)){c.q[b].svg&&(c.q[b].svg.remove(),c.q[b].svg=null),d=c.q[b].doc.bgImage().width(),e=c.q[b].doc.bgImage().height(),f=c.q[b].doc.bgImage().position().left,g=c.q[b].doc.bgImage().position().top,h="";for(var i in c.q[b].shapes)h+=c.q[b].shapes[i][0].outerHTML;c.q[b].svg=a("<svg>"+h+"</svg>"),c.q[b].doc.dragItemsArea.append(c.q[b].svg),c.q[b].svg.css("position","absolute").css("left",f+1).css("top",g+1).css("width",d).css("height",e)}},addShapeCircle:function(b,d,e,f){var g,h=e.match(/(\d+),(\d+);(\d+)/);if(h&&4===h.length){var i=Number(h[1]),j=Number(h[2]),k=Number(h[3]);if(c.coordsInBgImg(b,[i-k,j-k]))return g=a('<circle id="dz'+d+'" cx="'+i+'" cy="'+j+'" r="'+k+'" fill="'+f+'" fill-opacity="0.5" stroke="black" stroke-width="1" />'),c.q[b].shapes[d]=g,[i,j]}return null},addShapeRectangle:function(b,d,e,f){var g,h=e.match(/(\d+),(\d+);(\d+),(\d+)/);if(h&&5===h.length){var i=Number(h[1]),j=Number(h[2]),k=Number(h[3]),l=Number(h[4]);if(this.coordsInBgImg(b,[i+k,j+l]))return g=a('<rect id="dz'+d+'" width="'+k+'" height="'+l+'" x="'+i+'" y="'+j+'" fill="'+f+'" fill-opacity="0.5" stroke="black" stroke-width="1" />'),c.q[b].shapes[d]=g,[i+k/2,j+l/2]}return null},addShapePolygon:function(b,d,e,f){var g,h,i,j,k,l,m=e.split(";"),n=[],o=c.q[b].doc.bgImage().width(),p=c.q[b].doc.bgImage().height();for(l in m)h=m[l].match(/^(\d+),(\d+)$/),null!==h&&this.coordsInBgImg(b,[h[1],h[2]])&&(n[n.length]=[h[1],h[2]]);if(n.length>2){for(i=[0,0],j=[o,p],l=0;l<n.length;l++)j[0]=Math.min(n[l][0],j[0]),j[1]=Math.min(n[l][1],j[1]),i[0]=Math.max(n[l][0],i[0]),i[1]=Math.max(n[l][1],i[1]);return k=e.replace(/[,;]/g," "),g=a('<polygon id="dz'+d+'" fill="'+f+'" fill-opacity="0.5" stroke="black" stroke-width="1" points="'+k+'" />'),c.q[b].shapes[d]=g,[(j[0]+i[0])/2,(j[1]+i[1])/2]}return null}};return c});