define(["jquery","core/dragdrop"],function(a,b){"use strict";var c={dropzones:[],readOnly:!1,topnode:null,bgImageUrl:null,doc:null,pollTimer:null,imageReady:!1,colours:["#FFFFFF","#B0C4DE","#DCDCDC","#D8BFD8","#87CEFA","#DAA520","#FFD700","#F0E68C"],nextColourIndex:0,shapes:[],svg:null,init:function(d){c.dropzones=d.dropzones,c.readOnly=d.readOnly,c.topnode=a(d.topnode),c.bgImageUrl=d.bgimgurl,c.doc=c.docStructure(),c.readOnly||(c.doc.dragItemsArea.on("mousedown touchstart",function(d){d.preventDefault();var e=a(d.target.parentNode);e.hasClass("dragitem")&&(e.addClass("beingdragged"),b.prepare(d),b.start(d,e,null,c.dragEnd))}),c.doc.dragItemsArea.on("keydown keypress",c.dropzoneKeyPress),a(window).on("resize",c.redrawDragsAndDrops)),c.loadImage()},loadImage:function(){c.doc.bgImage().on("load",c.redrawDragsAndDrops),c.doc.bgImage().attr("src",c.bgImageUrl),c.doc.bgImage().css({border:"1px solid #000","max-width":"none"})},redrawDragsAndDrops:function(){if(c.doc.dragItems().each(function(b,c){a(c).addClass("unneeded")}),c.doc.inputsForChoices().each(function(a,b){for(var d=c.getChoiceNoForNode(b),e=c.getCoords(b),f=c.doc.dragItemHome(d),g=0;g<e.length;g++){var h=c.doc.dragItemForChoice(d,g);!h.length||h.hasClass("beingdragged")?h=c.cloneNewDragItem(f,g):h.removeClass("unneeded"),h.css("left",e[g][0]).css("top",e[g][1])}}),c.doc.dragItems().each(function(b,c){var d=a(c);d.hasClass("unneeded")&&!d.hasClass("beingdragged")&&d.remove()}),0!==c.dropzones.length){c.restartColours();for(var b in c.dropzones){var d=c.getNextColour(),e=c.dropzones[b];c.addDropzone(b,e.markertext,e.shape,e.coords,d,!0)}c.drawDropzones()}},cloneNewDragItem:function(a,b){var c=a.clone(!0);return c.removeClass("draghome"),c.addClass("dragitem"),c.addClass("item"+b),c.find("span.markertext").css("opacity",.6),a.after(c),c.attr("tabIndex",b),c},saveCoordsForChoice:function(a,b){for(var d,e,f,g=[],h=!0,i=0;i<=c.doc.dragItemsForChoice(a).length;i++)f=c.doc.dragItemForChoice(a,i),f.length&&(f.hasClass("beingdragged")||(d=c.convertToBgImgXY([f.offset().left,f.offset().top]),c.coordsInBgImg(d)&&(g[g.length]=d)),b&&0!==b.length&&b.get(0).innerText===f.get(0).innerText&&(h=!1));h&&(d=c.convertToBgImgXY([b.offset().left,b.offset().top]),c.coordsInBgImg(d)&&(g[g.length]=d)),e=g.join(";"),c.doc.inputForChoice(a).val(e)},coordsInBgImg:function(a){return a[0]>0&&a[1]>0&&a[0]<=c.doc.bgImage().width()&&a[1]<=c.doc.bgImage().height()},constrainToBgImg:function(a){var b=c.convertToBgImgXY(a);return b[0]=Math.max(0,b[0]),b[1]=Math.max(0,b[1]),b[0]=Math.min(c.doc.bgImage().width(),b[0]),b[1]=Math.min(c.doc.bgImage().height(),b[1]),c.convertToWindowXY(b)},convertToBgImgXY:function(a){return[Number(a[0])-c.doc.bgImage().offset().left-1,Number(a[1])-c.doc.bgImage().offset().top-1]},convertToWindowXY:function(a){return[Number(a[0])+c.doc.bgImage().position().left+1,Number(a[1])+c.doc.bgImage().position().top+1]},getCoords:function(b){var d=c.getChoiceNoForNode(b),e=a(b).val(),f=a(b).hasClass("infinite"),g=Number(c.doc.getClassnameNumericSuffix(b,"noofdrags")),h=c.doc.dragItemBeingDragged(d).length>0,i=[];if(""!==e)for(var j=e.split(";"),k=0;k<j.length;k++)i[k]=c.convertToWindowXY(j[k].split(","));var l=i.length+(h?1:0);return(f||l<g)&&(i[i.length]=c.dragHomeXY(d)),i},dragHomeXY:function(a){var b=c.doc.dragItemHome(a);return[b.position().left,b.position().top-12]},getChoiceNoForNode:function(a){return Number(c.doc.getClassnameNumericSuffix(a,"choice"))},dropzoneKeyPress:function(b){var d=a(b.target),e=[d.offset().left,d.offset().top],f={32:"remove",37:"left",38:"up",39:"right",40:"down",65:"left",87:"up",68:"right",83:"down",27:"remove"},g=f[b.keyCode];if(g){switch(b.preventDefault(),g){case"left":e[0]-=1;break;case"right":e[0]+=1;break;case"down":e[1]+=1;break;case"up":e[1]-=1;break;case"remove":e=null}var h=c.getChoiceNoForNode(d);e=null!==e?c.constrainToBgImg(e):c.dragHomeXY(h),d.css("left",e[0]).css("top",e[1]),c.saveCoordsForChoice(h,d),c.redrawDragsAndDrops()}},dragEnd:function(a,b,d){var e;d.removeClass("beingdragged"),e=c.getChoiceNoForNode(d),c.saveCoordsForChoice(e,d),c.redrawDragsAndDrops()},docStructure:function(){var b=c.topnode.find("div.dragitems:first");return{dragItemsArea:b,bgImage:function(){return c.topnode.find(".dropbackground:first")},dragItems:function(){return b.find(".dragitem")},dragItemsForChoice:function(a){return b.find("span.dragitem.choice"+a)},dragItemForChoice:function(a,c){return b.find("span.dragitem.choice"+a+".item"+c)},dragItemBeingDragged:function(a){return b.find("span.dragitem.beingdragged.choice"+a)},dragItemHome:function(a){return b.find("span.draghome.choice"+a)},dragItemHomes:function(){return b.find("span.draghome")},getClassnameNumericSuffix:function(b,c){var d=a(b).attr("class");if(void 0!==d&&""!==d)for(var e=d.split(" "),f=0;f<e.length;f++){var g=new RegExp("^"+c+"([0-9])+$");if(g.test(e[f])){var h=new RegExp("([0-9])+$"),i=h.exec(e[f]);return Number(i[0])}}return null},inputsForChoices:function(){return c.topnode.find("input.choices")},inputForChoice:function(a){return c.topnode.find("input.choice"+a)},markerTexts:function(){return c.topnode.find("div.markertexts")}}},restartColours:function(){c.nextColourIndex=0},getNextColour:function(){var a=c.colours[c.nextColourIndex];return c.nextColourIndex++,c.nextColourIndex===c.colours.length&&(c.nextColourIndex=0),a},addDropzone:function(a,b,d,e,f,g){var h;if(h=g?c.doc.markerTexts().find("span.markertext"+a+" a"):c.doc.markerTexts().find("span.markertext"+a),h.length)""!==b?h.html(b):h.remove();else if(""!==b){var i="markertext markertext"+a;g?c.doc.markerTexts().append('<span class="'+i+'"><a href="#">'+b+"</a></span>"):c.doc.markerTexts().append('<span class="'+i+'">'+b+"</span>")}var j="addShape_"+d;if(c[j]instanceof Function){var k=c[j](a,e,f);if(null!==k){var l=c.topnode.find("div.ddarea div.markertexts span.markertext"+a);if(null!==l){l.css("opacity","0.6"),k[0]-=l.outerWidth()/2,k[1]-=l.outerHeight()/2;var m=c.convertToWindowXY(k);l.css("position","absolute").css("left",m[0]-4).css("top",m[1]);var n=l.find("a");null!==n&&(n.on("click",function(){c.shapes[a].attr("fill-opacity",.7)}),n.attr("tabIndex",0))}}}},drawDropzones:function(){var b,d,e,f,g;if(!(c.shapes.length<1)){c.svg&&(c.svg.remove(),c.svg=null),b=c.doc.bgImage().width(),d=c.doc.bgImage().height(),e=c.doc.bgImage().position().left,f=c.doc.bgImage().position().top,g="";for(var h in c.shapes)g+=c.shapes[h][0].outerHTML;c.svg=a("<svg>"+g+"</svg>"),c.doc.dragItemsArea.append(c.svg),c.svg.css("position","absolute").css("left",e+1).css("top",f+1).css("width",b).css("height",d)}},addShape_circle:function(b,d,e){var f,g=d.match(/(\d+),(\d+);(\d+)/);if(g&&4===g.length){var h=Number(g[1]),i=Number(g[2]),j=Number(g[3]);if(c.coordsInBgImg([h-j,i-j]))return f=a('<circle id="dz'+b+'" cx="'+h+'" cy="'+i+'" r="'+j+'" fill="'+e+'" fill-opacity="0.5" stroke="black" stroke-width="1" />'),c.shapes[b]=f,[h,i]}return null},addShape_rectangle:function(b,d,e){var f,g=d.match(/(\d+),(\d+);(\d+),(\d+)/);if(g&&5===g.length){var h=Number(g[1]),i=Number(g[2]),j=Number(g[3]),k=Number(g[4]);if(this.coordsInBgImg([h+j,i+k]))return f=a('<rect id="dz'+b+'" width="'+j+'" height="'+k+'" x="'+h+'" y="'+i+'" fill="'+e+'" fill-opacity="0.5" stroke="black" stroke-width="1" />'),c.shapes[b]=f,[h+j/2,i+k/2]}return null},addShape_polygon:function(b,d,e){var f,g,h,i,j,k=d.split(";"),l=[],m=c.doc.bgImage().width(),n=c.doc.bgImage().height();for(var o in k)g=k[o].match(/^(\d+),(\d+)$/),null!==g&&this.coordsInBgImg([g[1],g[2]])&&(l[l.length]=[g[1],g[2]]);if(l.length>2){for(h=[0,0],i=[m,n],o=0;o<l.length;o++)i[0]=Math.min(l[o][0],i[0]),i[1]=Math.min(l[o][1],i[1]),h[0]=Math.max(l[o][0],h[0]),h[1]=Math.max(l[o][1],h[1]);return j=d.replace(/[,;]/g," "),f=a('<polygon id="dz'+b+'" fill="'+e+'" fill-opacity="0.5" stroke="black" stroke-width="1" points="'+j+'" />'),c.shapes[b]=f,[(i[0]+h[0])/2,(i[1]+h[1])/2]}return null}};return c});