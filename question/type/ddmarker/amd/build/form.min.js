define(["jquery","core/svgjs"],function(a,b){"use strict";var c={topnode:null,maxSizes:null,fp:null,pollTimer:null,imageReady:!1,bgImg:null,svg:{},shapes:{},init:function(b){c.topnode=a(b.topnode),c.maxSizes=b.maxsizes.bgimage,c.fp=c.filePickers(),c.setupPreviewArea(),c.setOptionsForDragItemSelectors(),c.setupFormEvents(),c.whenImageReady()},whenImageReady:function(){if(!c.imageReady){var a=c.fp.file("bgimage").href;null!==a?(null!==c.pollTimer&&(clearTimeout(c.pollTimer),c.pollTimer=null),c.imageReady=!0,c.filepickerOnChange(),c.loadPreviewImage()):c.pollTimer=setTimeout(c.whenImageReady,1e3)}},filepickerOnChange:function(){a("form.mform").on("change","#id_bgimage",c.loadPreviewImage)},loadPreviewImage:function(){var a=c.fp.file("bgimage").href;c.bgImg=c.topnode.find(".dropbackground"),c.bgImg.one("load",c.afterImageLoaded),c.bgImg.attr("src",a),c.bgImg.css({border:"1px solid #000","max-width":"none"})},afterImageLoaded:function(){c.constrainImageSize(),a("#ddm-dropzone").css("position","relative").css("top",(c.bgImg.height()+1)*-1),a("#ddm-droparea").css("height",c.bgImg.height()+20),c.addDropzones()},constrainImageSize:function(){var a=Math.max(c.bgImg.width()/c.maxSizes.width,c.bgImg.height()/c.maxSizes.height);a>1&&c.bgImg.css("width",Math.floor(c.bgImg.width()/a)),c.bgImg.addClass("constrained")},addDropzones:function(){var d,e,f,g,h,i;for(a.isEmptyObject(c.svg)||a("svg").remove(),c.svg=b("ddm-dropzone").size(c.bgImg.outerWidth(),c.bgImg.outerHeight()),d=c.form.getFormValue("nodropzone",[]),e=0;e<d;e++)f=c.form.getFormValue("drops",[e,"choice"]),g=c.getMarkerText(f),h=c.form.getFormValue("drops",[e,"shape"]),i=c.getCoords(e),""!==i&&c.addShape(e,h,i,g);c.addEditingFeatures()},addShape:function(a,b,d,e){var f,g,h,i,j,k,l,m,n,o,p,q,r,s;switch(b){case"circle":f=d.match(/(\d+),(\d+);(\d+)/),f&&4===f.length&&(r=Number(f[1]),s=Number(f[2]),i=Number(f[3]),c.shapes[a]={shape:b,center:[r,s],radius:i},c.shapes[a].dropzone=c.svg.circle(2*i).cx(r).cy(s).attr({fill:"#FFF","fill-opacity":.2,stroke:"#000","stroke-width":1}).addClass("dzno"+a),c.shapes[a].markerText=c.svg.text(e).cx(r).cy(s+15));break;case"rectangle":f=d.match(/(\d+),(\d+);(\d+),(\d+)/),f&&5===f.length&&(g=Number(f[1]),h=Number(f[2]),j=Number(f[3]),k=Number(f[4]),r=g+j/2,s=h+k/2,c.shapes[a]={shape:b,center:[r,s],top:[g,h],width:j,height:k},c.shapes[a].dropzone=c.svg.rect(j,k).x(g).y(h).attr({fill:"#FFF","fill-opacity":.2,stroke:"#000","stroke-width":1}).addClass("dzno"+a),c.shapes[a].markerText=c.svg.text(e).cx(r).cy(s+15));break;case"polygon":f=d.split(";"),l=[];for(q in f)m=f[q].match(/^(\d+),(\d+)$/),null!==m&&(l[l.length]=[Number(m[1]),Number(m[2])]);if(l.length>2){for(n=[0,0],o=[c.maxSizes.width,c.maxSizes.height],q=0;q<l.length;q++)o[0]=Math.min(l[q][0],o[0]),o[1]=Math.min(l[q][1],o[1]),n[0]=Math.max(l[q][0],n[0]),n[1]=Math.max(l[q][1],n[1]);r=(o[0]+n[0])/2,s=(o[1]+n[1])/2,p=d.replace(/[;]/g," "),c.shapes[a]={shape:b,center:[r,s],xy:l},c.shapes[a].dropzone=c.svg.polygon(p).attr({fill:"#FFF","fill-opacity":.2,stroke:"#000","stroke-width":1}).addClass("dzno"+a),c.shapes[a].markerText=c.svg.text(e).cx(r).cy(s+15)}}},addEditingFeatures:function(){if(!a.isEmptyObject(c.shapes))for(var b in c.shapes)c.shapes[b].dropzone.on("click",c.addHandles)},addHandles:function(a){var b,d,e=a.currentTarget.className.baseVal.slice(4),f=c.shapes[e].center;if(c.shapes[e].hasOwnProperty("editing")&&c.shapes[e].editing){if(c.shapes[e].movehandle.remove(),c.shapes[e].dropzone.attr("stroke-width",1),"polygon"===c.shapes[e].shape)for(b=c.shapes[e].xy,d=0;d<b.length;d++)c.shapes[e].resizehandle[d].remove();else c.shapes[e].resizehandle.remove();c.shapes[e].editing=!1,c.shapes[e].moving=!1,c.shapes[e].resizeing=!1}else switch(c.shapes[e].editing=!0,c.shapes[e].dropzone.attr("stroke-width",2),c.shapes[e].movehandle=c.svg.circle(10).cx(f[0]).cy(f[1]).attr({fill:"white","fill-opacity":.1,stroke:"red","stroke-width":1}).style("cursor","pointer").addClass("dzno"+e),c.shapes[e].movehandle.on("mousedown",c.moveStart),c.shapes[e].movehandle.on("mousemove",c.move),c.shapes[e].movehandle.on("mouseup",c.moveEnd),c.shapes[e].shape){case"circle":c.shapes[e].resizehandle=c.svg.rect(7,7).cx(f[0]+c.shapes[e].radius).cy(f[1]).attr({fill:"white","fill-opacity":.1,stroke:"blue","stroke-width":1}).addClass("dzno"+e),c.shapes[e].resizehandle.on("mousedown",c.resizeStart),c.shapes[e].resizehandle.on("mousemove",c.resize),c.shapes[e].resizehandle.on("mouseup",c.resizeEnd);break;case"rectangle":c.shapes[e].resizehandle=c.svg.rect(7,7).cx(c.shapes[e].top[0]+c.shapes[e].width).cy(c.shapes[e].top[1]+c.shapes[e].height).attr({fill:"white","fill-opacity":.1,stroke:"blue","stroke-width":1}).addClass("dzno"+e),c.shapes[e].resizehandle.on("mousedown",c.resizeStart),c.shapes[e].resizehandle.on("mousemove",c.resize),c.shapes[e].resizehandle.on("mouseup",c.resizeEnd);break;case"polygon":for(b=c.shapes[e].xy,c.shapes[e].resizehandle=[],d=0;d<b.length;d++)c.shapes[e].resizehandle[d]=c.svg.rect(7,7).cx(b[d][0]).cy(b[d][1]).attr({fill:"white","fill-opacity":.1,stroke:"blue","stroke-width":1}).addClass("dzno"+e).data("resizeno",d),c.shapes[e].resizehandle[d].on("mousedown",c.resizeStart),c.shapes[e].resizehandle[d].on("mousemove",c.resize),c.shapes[e].resizehandle[d].on("mouseup",c.resizeEnd)}},moveStart:function(a){var b=a.currentTarget.className.baseVal.slice(4);c.shapes[b].moving=!0,c.shapes[b].resizeing=!1},move:function(a){var b,d,e,f,g,h=a.currentTarget.className.baseVal.slice(4);if(c.shapes[h].hasOwnProperty("moving")&&c.shapes[h].moving){switch(b=c.shapes[h].center,f=a.movementX,g=a.movementY,b=[b[0]+f,b[1]+g],c.shapes[h].shape){case"circle":c.shapes[h].resizehandle.cx(b[0]+c.shapes[h].radius).cy(b[1]),c.shapes[h].dropzone.cx(b[0]).cy(b[1]);break;case"rectangle":c.shapes[h].resizehandle.cx(b[0]+c.shapes[h].width/2).cy(b[1]+c.shapes[h].height/2),c.shapes[h].top=[b[0]-c.shapes[h].width/2,b[1]-c.shapes[h].height/2],c.shapes[h].dropzone.cx(b[0]).cy(b[1]);break;case"polygon":d=c.shapes[h].xy,e=[];for(var i=0;i<d.length;i++)c.shapes[h].resizehandle[i].cx(d[i][0]+f).cy(d[i][1]+g),e[i]=[d[i][0]+f,d[i][1]+g];c.shapes[h].xy=e,c.shapes[h].dropzone.plot(e)}c.shapes[h].movehandle.cx(b[0]).cy(b[1]),c.shapes[h].center=b,c.shapes[h].markerText.cx(b[0]).cy(b[1]+15)}},moveEnd:function(a){var b,d,e=a.currentTarget.className.baseVal.slice(4);switch(c.shapes[e].moving=!1,c.shapes[e].shape){case"circle":b=c.shapes[e].center[0]+","+c.shapes[e].center[1]+";"+c.shapes[e].radius,c.form.setFormValue("drops",[e,"coords"],b);break;case"rectangle":b=Math.round(c.shapes[e].top[0])+","+Math.round(c.shapes[e].top[1])+";"+Math.round(c.shapes[e].width)+","+Math.round(c.shapes[e].height),c.form.setFormValue("drops",[e,"coords"],b);break;case"polygon":for(b="",d=0;d<c.shapes[e].xy.length;d++)b=b+Math.round(c.shapes[e].xy[d][0])+","+Math.round(c.shapes[e].xy[d][1])+";";b=b.slice(0,b.length-1),c.form.setFormValue("drops",[e,"coords"],b)}},resizeStart:function(a){var b,d=a.currentTarget.className.baseVal.slice(4);c.shapes[d].moving=!1,c.shapes[d].resizeing=!0,"polygon"===c.shapes[d].shape&&a.ctrlKey&&(b=a.currentTarget.dataset.resizeno,c.addNewHandle(d,b))},resize:function(a){var b,d,e,f,g,h,i,j,k,l,m,n=a.currentTarget.className.baseVal.slice(4);if(c.shapes[n].hasOwnProperty("resizeing")&&c.shapes[n].resizeing)switch(m=c.shapes[n].center,c.shapes[n].shape){case"circle":var o=c.shapes[n].radius+a.movementX;o>1&&(c.shapes[n].resizehandle.cx(m[0]+o),c.shapes[n].radius=o,c.shapes[n].dropzone.radius(o));break;case"rectangle":b=c.shapes[n].width+a.movementX,d=c.shapes[n].height+a.movementY,b>1&&d>1&&(c.shapes[n].width=b,c.shapes[n].height=d,c.shapes[n].dropzone.size(b,d),i=c.shapes[n].resizehandle.cx()+a.movementX,j=c.shapes[n].resizehandle.cy()+a.movementY,c.shapes[n].resizehandle.cx(i).cy(j),i=c.shapes[n].top[0]+b/2,j=c.shapes[n].top[1]+d/2,c.shapes[n].movehandle.cx(i).cy(j),c.shapes[n].markerText.cx(i).cy(j+15),c.shapes[n].center=[i,j]);break;case"polygon":if(e=a.currentTarget.dataset.resizeno,void 0!==e){for(e=Number(e),f=c.shapes[n].xy,i=c.shapes[n].resizehandle[e].cx()+a.movementX,j=c.shapes[n].resizehandle[e].cy()+a.movementY,c.shapes[n].resizehandle[e].cx(i).cy(j),f[e]=[i,j],g=[],h=0;h<f.length;h++)g.push(f[h]);for(c.shapes[n].dropzone.plot(g),k=[c.maxSizes.width,c.maxSizes.height],l=[0,0],h=0;h<f.length;h++)k[0]=Math.min(f[h][0],k[0]),k[1]=Math.min(f[h][1],k[1]),l[0]=Math.max(f[h][0],l[0]),l[1]=Math.max(f[h][1],l[1]);i=(k[0]+l[0])/2,j=(k[1]+l[1])/2,c.shapes[n].center=[i,j],c.shapes[n].movehandle.cx(i).cy(j),c.shapes[n].markerText.cx(i).cy(j+15)}}},resizeEnd:function(a){var b,d,e,f=a.currentTarget.className.baseVal.slice(4);switch(c.shapes[f].resizeing=!1,c.shapes[f].shape){case"circle":b=c.shapes[f].center[0]+","+c.shapes[f].center[1]+";"+c.shapes[f].radius,c.form.setFormValue("drops",[f,"coords"],b);break;case"rectangle":b=c.shapes[f].top[0]+","+c.shapes[f].top[1]+";"+c.shapes[f].width+","+c.shapes[f].height,c.form.setFormValue("drops",[f,"coords"],b);break;case"polygon":for(d=c.shapes[f].xy,b="",e=0;e<d.length;e++)b=b+Math.round(d[e][0])+","+Math.round(d[e][1])+";";""!==b&&(b=b.slice(0,b.length-1),c.form.setFormValue("drops",[f,"coords"],b))}},addNewHandle:function(a,b){var d,e,f,g;for(d="",e=c.shapes[a].xy,f=0;f<e.length;f++)d=d+Math.round(e[f][0])+","+Math.round(e[f][1])+";",f===Number(b)&&(g=f+1===e.length?0:f+1,d=d+Math.round((e[f][0]+e[g][0])/2)+","+Math.round((e[f][1]+e[g][1])/2)+";");d=d.slice(0,d.length-1),c.form.setFormValue("drops",[a,"coords"],d),c.addDropzones()},getCoords:function(a){var b=c.form.getFormValue("drops",[a,"coords"]);return b.replace(new RegExp("\\s*","g"),"")},getMarkerText:function(a){if(0!==Number(a)){var b=c.form.getFormValue("drags",[a-1,"label"]);return b.replace(new RegExp("^\\s*(.*)\\s*$"),"$1")}return""},setupPreviewArea:function(){c.topnode.find("div.fcontainer").append('<div class="ddarea">   <div class="markertexts"></div>   <div id="ddm-droparea" class="droparea">       <img class="dropbackground" />       <div id="ddm-dropzone" class="dropzones"></div>   </div></div>')},setOptionsForDragItemSelectors:function(){var b,d,e,f={0:""},g=c.form.getFormValue("noitems",[]),h=[];for(d=1;d<=g;d++)e=c.getMarkerText(d),""!==e&&(f[d]=a("<div/>").text(e).html());for(d=0;d<c.form.getFormValue("nodropzone",[]);d++)b=a("#id_drops_"+d+"_choice"),h[d]=Number(b.val());for(d=0;d<c.form.getFormValue("nodropzone",[]);d++){b=a("#id_drops_"+d+"_choice"),b.find("option").remove();for(var i in f){i=Number(i);var j='<option value="'+i+'">'+f[i]+"</option>";b.append(j);var k=b.find('option[value="'+i+'"]');if(i===h[d])k.attr("selected",!0);else if(0!==i){var l=c.form.getFormValue("drags",[i-1,"noofdrags"]);if(0!==Number(l))for(var m in h)if(Number(h[m])===i){if(1===Number(l)){k.attr("disabled",!0);break}l--}}}}},updateShape:function(a,b){var d,e,f,g,h,i,j,k,l,m,n,o,p,q;if(e="",d=c.getCoords(a),""===d)switch(b){case"circle":e="30,30;20";break;case"rectangle":e="10,10;30,30";break;case"polygon":e="10,10;40,20;20,40"}else{f=d.split(";"),h=[];for(i in f)g=f[i].match(/^(\d+),(\d+)$/),null!==g&&(h[h.length]=[Number(g[1]),Number(g[2])]);switch(b){case"circle":2===h.length&&(l=h[1][0],m=h[1][1],j=Math.round(h[0][0]+l/2),k=Math.round(h[0][1]+m/2),e=j+","+k+";"+Math.round((l+m)/4)),h.length>2&&(j=Math.round(c.shapes[a].center[0]),k=Math.round(c.shapes[a].center[1]),l=Math.abs(Math.round(h[0][0]-j)),l<10&&(l=10),e=j+","+k+";"+l);break;case"rectangle":if(1===h.length&&(l=2*c.shapes[a].radius,n=Math.abs(Math.round(h[0][0]-l/2)),o=Math.abs(Math.round(h[0][1]-l/2)),e=n+","+o+";"+l+","+l),h.length>2){for(p=[c.maxSizes.width,c.maxSizes.height],q=[0,0],i=0;i<h.length;i++)p[0]=Math.min(h[i][0],p[0]),p[1]=Math.min(h[i][1],p[1]),q[0]=Math.max(h[i][0],q[0]),q[1]=Math.max(h[i][1],q[1]);l=Math.abs(Math.round(q[0]-p[0])),l<10&&(l=10),m=Math.abs(Math.round(q[1]-p[1])),m<10&&(m=10),n=p[0],o=p[1],e=n+","+o+";"+l+","+m}break;case"polygon":1===h.length&&(l=2*c.shapes[a].radius,n=Math.abs(Math.round(h[0][0]-l/2)),o=Math.abs(Math.round(h[0][1]-l/2)),e=n+","+o+";"+(n+l)+","+o+";"+(n+l)+","+(o+l)+";"+n+","+(o+l)),2===h.length&&(n=Math.round(h[0][0]),o=Math.round(h[0][1]),l=Math.round(h[1][0]),m=Math.round(h[1][1]),e=n+","+o+";"+(n+l)+","+o+";"+(n+l)+","+(o+m)+";"+n+","+(o+m))}}c.form.setFormValue("drops",[a,"coords"],e),c.addDropzones()},setupFormEvents:function(){a("fieldset#id_draggableitemheader").on("change","input",function(){c.setOptionsForDragItemSelectors()}),a("fieldset#id_draggableitemheader").on("change","select",function(){c.setOptionsForDragItemSelectors()}),a("fieldset#id_dropzoneheader").on("change","select",function(a){var b=a.currentTarget.id.match(/^id_drops_(\d+)_([a-z]*)$/);b&&("shape"===b[2]?c.updateShape(b[1],a.currentTarget.value):c.addDropzones())}),a("fieldset#id_dropzoneheader").on("change","input",function(){c.addDropzones()})},form:{toNameWithIndex:function(a,b){for(var c=a,d=0;d<b.length;d++)c=c+"["+b[d]+"]";return c},getEl:function(a,b){var c=document.getElementById("mform1");return c.elements[this.toNameWithIndex(a,b)]},getFormValue:function(a,b){var c=this.getEl(a,b);return"checkbox"===c.type?c.checked:c.value},setFormValue:function(a,b,c){var d=this.getEl(a,b);"checkbox"===d.type?d.checked=c:d.value=c}},filePickers:function(){var b,c,d;return void 0===b&&(b={},c={},d=a("form.mform input.filepickerhidden"),d.each(function(a,d){b[d.value]=d.name,c[d.name]=d.parentNode})),{file:function(b){var d=a(c[b]),e=d.find("div.filepicker-filelist a");return e.length?{href:e.get(0).href,name:e.get(0).innerHTML}:{href:null,name:null}},name:function(a){return b[a]}}}};return c});